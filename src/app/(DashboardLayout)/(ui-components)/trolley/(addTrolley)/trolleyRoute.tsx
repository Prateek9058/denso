import React, { useState, useRef, useEffect } from 'react';
import { Grid, Paper, Button, Box } from '@mui/material';
import {
    MapContainer,
    ImageOverlay,
    Marker,
    Polyline,
    useMapEvents,
} from 'react-leaflet';
import DeleteIcon from '@mui/icons-material/Delete';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';

type Point = [number, number];

interface PointWithMarker {
    coordinates: Point;
    showMarker?: boolean;
}
interface TrolleyRouteProps {
    points: PointWithMarker[];
    setPoints: React.Dispatch<React.SetStateAction<PointWithMarker[]>>;
}

const allowedCoordinates: Point[] = [
    [
        61.91250038146973,
        23.609108198800957
    ],
    [
        62.03750038146973,
        30.355918023095576
    ],
    [
        62.16250038146973,
        32.979677399210146
    ],
    [
        62.03750038146973,
        35.22861400730835
    ],
    [
        62.03750038146973,
        37.35260969273443
    ],
    [
        62.28750038146973,
        39.47660537816052
    ],
    [
        62.16250038146973,
        41.725541986258726
    ],
    [
        62.28750038146973,
        45.848592434438764
    ],
    [
        62.16250038146973,
        48.22246996520909
    ],
    [
        62.03750038146973,
        50.72128841865155
    ],
    [
        62.03750038146973,
        52.59540225873338
    ],
    [
        62.16250038146973,
        54.594457021487344
    ],
    [
        61.91250038146973,
        57.0932754749298
    ],
    [
        62.16250038146973,
        59.46715300570012
    ],
    [
        62.41250038146973,
        63.2153806858638
    ],
    [
        62.16250038146973,
        65.71419913930626
    ],
    [
        62.41250038146973,
        67.71325390206022
    ],
    [
        62.41250038146973,
        69.8372495874863
    ],
    [
        62.03750038146973,
        74.21018188101058
    ],
    [
        62.16250038146973,
        75.95935479842029
    ],
    [
        62.16250038146973,
        78.08335048384637
    ],
    [
        62.28750038146973,
        80.20734616927245
    ],
    [
        62.03750038146973,
        82.70616462271491
    ],
    [
        61.91250038146973,
        87.70380152959982
    ],
    [
        61.91250038146973,
        89.70285629235377
    ],
    [
        62.16250038146973,
        84.95510123081311
    ],
    [
        59.78750038146973,
        83.7056920040919
    ],
    [
        57.16250038146973,
        83.7056920040919
    ],
    [
        55.03750038146973,
        83.7056920040919
    ],
    [
        53.16250038146973,
        83.7056920040919
    ],
    [
        50.28750038146973,
        83.83063292676403
    ],
    [
        47.66250038146973,
        83.7056920040919
    ],
    [
        47.53750038146973,
        86.45439230287859
    ],
    [
        47.53750038146973,
        88.57838798830467
    ],
    [
        47.53750038146973,
        90.952265519075
    ],
    [
        48.03750038146973,
        93.0762612045011
    ],
    [
        49.91250038146973,
        93.82590674053381
    ],
    [
        51.91250038146973,
        93.70096581786169
    ],
    [
        54.03750038146973,
        93.82590674053381
    ],
    [
        56.41250038146973,
        93.95084766320593
    ],
    [
        58.78750038146973,
        93.70096581786169
    ],
    [
        60.78750038146973,
        93.57602489518958
    ],
    [
        48.16250038146973,
        95.07531596725505
    ],
    [
        48.03750038146973,
        96.94942980733688
    ],
    [
        48.03750038146973,
        98.82354364741872
    ],
    [
        47.91250038146973,
        101.19742117818905
    ],
    [
        47.91250038146973,
        102.94659409559875
    ],
    [
        47.78750038146973,
        105.32047162636908
    ],
    [
        50.03750038146973,
        104.82070793568059
    ],
    [
        52.16250038146973,
        104.69576701300849
    ],
    [
        54.28750038146973,
        104.82070793568059
    ],
    [
        56.78750038146973,
        104.82070793568059
    ],
    [
        58.53750038146973,
        104.57082609033637
    ],
    [
        60.66250038146973,
        104.69576701300849
    ],
    [
        48.03750038146973,
        107.44446731179517
    ],
    [
        48.03750038146973,
        109.1936402292049
    ],
    [
        48.03750038146973,
        110.94281314661461
    ],
    [
        47.53750038146973,
        112.81692698669644
    ],
    [
        47.91250038146973,
        116.93997743487648
    ],
    [
        49.78750038146973,
        116.93997743487648
    ],
    [
        51.66250038146973,
        116.69009558953223
    ],
    [
        53.28750038146973,
        116.69009558953223
    ],
    [
        55.03750038146973,
        117.0649183575486
    ],
    [
        56.66250038146973,
        116.93997743487648
    ],
    [
        58.66250038146973,
        116.93997743487648
    ],
    [
        60.28750038146973,
        116.93997743487648
    ],
    [
        62.16250038146973,
        116.44021374418799
    ],
    [
        62.16250038146973,
        114.44115898143403
    ],
    [
        62.28750038146973,
        112.5670451413522
    ],
    [
        62.53750038146973,
        110.69293130127036
    ],
    [
        62.03750038146973,
        118.81409127495832
    ],
    [
        64.16250038146973,
        117.43974112556498
    ],
    [
        66.41250038146973,
        117.18985928022073
    ],
    [
        68.66250038146973,
        117.68962297090923
    ],
    [
        71.03750038146973,
        117.93950481625347
    ],
    [
        72.78750038146973,
        117.93950481625347
    ],
    [
        75.03750038146973,
        117.5646820482371
    ],
    [
        62.16250038146973,
        120.9380869603844
    ],
    [
        61.66250038146973,
        123.43690541382685
    ],
    [
        66.78750038146973,
        126.56042848062992
    ],
    [
        68.91250038146973,
        126.56042848062992
    ],
    [
        70.66250038146973,
        126.68536940330205
    ],
    [
        72.66250038146973,
        126.68536940330205
    ],
    [
        75.03750038146973,
        126.68536940330205
    ],
    [
        63.91250038146973,
        126.68536940330205
    ],
    [
        62.03750038146973,
        128.18466047536754
    ],
    [
        62.16250038146973,
        130.18371523812147
    ],
    [
        62.16250038146973,
        132.18277000087545
    ],
    [
        62.16250038146973,
        134.18182476362938
    ],
    [
        64.28750038146973,
        135.18135214500637
    ],
    [
        66.53750038146973,
        134.93147029966212
    ],
    [
        68.41250038146973,
        135.18135214500637
    ],
    [
        70.53750038146973,
        135.18135214500637
    ],
    [
        72.91250038146973,
        135.05641122233425
    ],
    [
        74.78750038146973,
        135.3062930676785
    ],
    [
        74.78750038146973,
        137.18040690776036
    ],
    [
        74.78750038146973,
        138.8046389024979
    ],
    [
        74.91250038146973,
        140.42887089723553
    ],
    [
        74.66250038146973,
        142.17804381464524
    ],
    [
        72.28750038146973,
        143.55239396403857
    ],
    [
        69.66250038146973,
        143.42745304136645
    ],
    [
        67.16250038146973,
        143.55239396403857
    ],
    [
        64.41250038146973,
        143.30251211869432
    ],
    [
        62.41250038146973,
        143.6773348867107
    ],
    [
        61.78750038146973,
        141.67828012395677
    ],
    [
        62.16250038146973,
        139.3044025931864
    ],
    [
        61.91250038146973,
        136.55570229439974
    ],
    [
        62.03750038146973,
        146.05121241748105
    ],
    [
        62.16250038146973,
        147.92532625756286
    ],
    [
        64.66250038146973,
        150.29920378833322
    ],
    [
        66.91250038146973,
        149.92438102031684
    ],
    [
        68.66250038146973,
        150.1742628656611
    ],
    [
        71.03750038146973,
        149.92438102031684
    ],
    [
        73.28750038146973,
        149.92438102031684
    ],
    [
        74.91250038146973,
        149.54955825230047
    ],
    [
        75.16250038146973,
        147.17568072153014
    ],
    [
        74.78750038146973,
        144.6768622680877
    ],
    [
        74.53750038146973,
        152.17331762841502
    ],
    [
        74.66250038146973,
        154.6721360818575
    ],
    [
        74.66250038146973,
        157.17095453529993
    ],
    [
        72.28750038146973,
        156.17142715392296
    ],
    [
        69.91250038146973,
        156.2963680765951
    ],
    [
        67.53750038146973,
        156.2963680765951
    ],
    [
        65.03750038146973,
        156.2963680765951
    ],
    [
        62.16250038146973,
        154.04743146849688
    ],
    [
        62.03750038146973,
        151.9234357830708
    ],
    [
        62.16250038146973,
        160.54435944744725
    ],
    [
        62.28750038146973,
        162.91823697821758
    ],
    [
        64.28750038146973,
        163.41800066890607
    ],
    [
        66.41250038146973,
        162.91823697821758
    ],
    [
        68.91250038146973,
        163.29305974623395
    ],
    [
        71.53750038146973,
        163.16811882356183
    ],
    [
        73.66250038146973,
        163.16811882356183
    ],
    [
        75.41250038146973,
        162.91823697821758
    ],
    [
        74.91250038146973,
        160.91918221546362
    ],
    [
        75.16250038146973,
        159.0450683753818
    ],
    [
        74.66250038146973,
        164.91729174097154
    ],
    [
        74.91250038146973,
        166.9163465037255
    ],
    [
        74.53750038146973,
        168.79046034380735
    ],
    [
        74.53750038146973,
        170.9144560292334
    ],
    [
        74.78750038146973,
        172.9135107919874
    ],
    [
        74.78750038146973,
        175.03750647741344
    ],
    [
        74.91250038146973,
        177.4113840081838
    ],
    [
        74.41250038146973,
        179.91020246162623
    ],
    [
        74.53750038146973,
        181.7843163017081
    ],
    [
        74.53750038146973,
        184.03325290980627
    ],
    [
        74.41250038146973,
        186.08630435024025
    ],
    [
        74.78750038146973,
        188.33524095833846
    ],
    [
        74.91250038146973,
        190.8340594117809
    ],
    [
        74.91250038146973,
        193.08299601987912
    ],
    [
        74.66250038146973,
        195.83169631866582
    ],
    [
        74.78750038146973,
        198.080632926764
    ],
    [
        74.66250038146973,
        200.82933322555073
    ],
    [
        77.16250038146973,
        199.95474676684586
    ],
    [
        79.41250038146973,
        200.07968768951798
    ],
    [
        81.91250038146973,
        200.32956953486223
    ],
    [
        84.03750038146973,
        200.2046286121901
    ],
    [
        86.78750038146973,
        200.2046286121901
    ],
    [
        88.91250038146973,
        200.2046286121901
    ],
    [
        74.28750038146973,
        203.32815167899315
    ],
    [
        74.28750038146973,
        205.0773245964029
    ],
    [
        74.28750038146973,
        207.32626120450107
    ],
    [
        74.41250038146973,
        209.20037504458293
    ],
    [
        72.53750038146973,
        180.8387855980111
    ],
    [
        70.28750038146973,
        180.96372652068322
    ],
    [
        67.78750038146973,
        180.96372652068322
    ],
    [
        65.41250038146973,
        180.96372652068322
    ],
    [
        63.16250038146973,
        180.96372652068322
    ],
    [
        61.91250038146973,
        177.21549884051956
    ],
    [
        62.28750038146973,
        175.46632592310982
    ],
    [
        62.03750038146973,
        173.84209392837226
    ],
    [
        61.91250038146973,
        171.4682163976019
    ],
    [
        62.03750038146973,
        169.46916163484798
    ],
    [
        62.41250038146973,
        166.9703431814055
    ],
    [
        62.53750038146973,
        164.97128841865154
    ],
    [
        61.41250038146973,
        179.21455360327352
    ],
    [
        59.16250038146973,
        180.3390219073226
    ],
    [
        56.91250038146973,
        180.3390219073226
    ],
    [
        54.53750038146973,
        180.08914006197836
    ],
    [
        51.78750038146973,
        180.08914006197836
    ],
    [
        50.16250038146973,
        180.08914006197836
    ],
    [
        47.66250038146973,
        175.71620776845407
    ],
    [
        47.53750038146973,
        173.4672711603559
    ],
    [
        47.66250038146973,
        171.4682163976019
    ],
    [
        47.66250038146973,
        169.7190434801922
    ],
    [
        47.41250038146973,
        167.34516594942187
    ],
    [
        47.41250038146973,
        165.2211702639958
    ],
    [
        47.66250038146973,
        162.84729273322546
    ],
    [
        47.78750038146973,
        160.8482379704715
    ],
    [
        47.91250038146973,
        158.5993013623733
    ],
    [
        50.03750038146973,
        158.47436043970117
    ],
    [
        52.16250038146973,
        158.34941951702905
    ],
    [
        54.16250038146973,
        158.34941951702905
    ],
    [
        56.16250038146973,
        158.22447859435692
    ],
    [
        58.66250038146973,
        158.22447859435692
    ],
    [
        60.28750038146973,
        158.22447859435692
    ],
    [
        62.66250038146973,
        156.10048290893084
    ],
    [
        62.66250038146973,
        158.47436043970117
    ],
    [
        48.03750038146973,
        156.72518752229146
    ],
    [
        48.03750038146973,
        154.7261327595375
    ],
    [
        48.03750038146973,
        152.97695984212777
    ],
    [
        48.03750038146973,
        151.22778692471806
    ],
    [
        47.78750038146973,
        149.2287321619641
    ],
    [
        49.41250038146973,
        149.47861400730835
    ],
    [
        51.16250038146973,
        149.35367308463623
    ],
    [
        53.03750038146973,
        149.7284958526526
    ],
    [
        55.28750038146973,
        149.2287321619641
    ],
    [
        57.16250038146973,
        148.85390939394773
    ],
    [
        58.78750038146973,
        148.85390939394773
    ],
    [
        61.66250038146973,
        149.7284958526526
    ],
    [
        48.03750038146973,
        146.85485463119377
    ],
    [
        47.41250038146973,
        144.7308589457677
    ],
    [
        48.16250038146973,
        142.73180418301374
    ],
    [
        47.78750038146973,
        140.48286757491553
    ],
    [
        50.03750038146973,
        140.10804480689916
    ],
    [
        52.41250038146973,
        140.23298572957128
    ],
    [
        54.16250038146973,
        140.10804480689916
    ],
    [
        56.66250038146973,
        140.10804480689916
    ],
    [
        59.16250038146973,
        140.10804480689916
    ],
    [
        47.53750038146973,
        138.23393096681733
    ],
    [
        47.66250038146973,
        136.23487620406337
    ],
    [
        49.53750038146973,
        135.23534882268638
    ],
    [
        51.28750038146973,
        135.23534882268638
    ],
    [
        53.16250038146973,
        135.23534882268638
    ],
    [
        55.16250038146973,
        135.23534882268638
    ],
    [
        57.28750038146973,
        135.3602897453585
    ],
    [
        59.66250038146973,
        134.86052605467
    ],
    [
        47.53750038146973,
        133.48617590527667
    ],
    [
        47.66250038146973,
        131.61206206519483
    ],
    [
        47.66250038146973,
        129.48806637976875
    ],
    [
        47.91250038146973,
        127.73889346235903
    ],
    [
        47.53750038146973,
        125.61489777693295
    ],
    [
        50.16250038146973,
        125.61489777693295
    ],
    [
        52.03750038146973,
        125.61489777693295
    ],
    [
        54.28750038146973,
        125.73983869960507
    ],
    [
        56.53750038146973,
        125.48995685426083
    ],
    [
        58.66250038146973,
        125.3650159315887
    ],
    [
        61.28750038146973,
        125.3650159315887
    ],
    [
        47.66250038146973,
        123.61584301417899
    ],
    [
        47.78750038146973,
        121.36690640608079
    ],
    [
        48.16250038146973,
        119.11796979798258
    ],
    [
        48.41250038146973,
        114.99491934980253
    ],
    [
        45.03750038146973,
        116.99397411255649
    ],
    [
        42.16250038146973,
        116.99397411255649
    ],
    [
        39.66250038146973,
        116.74409226721224
    ],
    [
        37.16250038146973,
        117.24385595790073
    ],
    [
        34.28750038146973,
        116.99397411255649
    ],
    [
        31.662500381469727,
        117.11891503522861
    ],
    [
        30.912500381469727,
        119.11796979798257
    ],
    [
        30.537500381469727,
        121.4918473287529
    ],
    [
        30.287500381469727,
        123.99066578219535
    ],
    [
        30.412500381469727,
        125.98972054494931
    ],
    [
        32.28750038146973,
        125.61489777693295
    ],
    [
        34.28750038146973,
        125.61489777693295
    ],
    [
        36.66250038146973,
        125.61489777693295
    ],
    [
        38.66250038146973,
        125.73983869960506
    ],
    [
        40.66250038146973,
        125.61489777693295
    ],
    [
        42.66250038146973,
        125.86477962227718
    ],
    [
        45.16250038146973,
        125.48995685426083
    ],
    [
        30.662500381469727,
        128.1137162303754
    ],
    [
        30.662500381469727,
        130.48759376114572
    ],
    [
        30.787500381469727,
        132.73653036924392
    ],
    [
        30.662500381469727,
        134.86052605467
    ],
    [
        30.912500381469727,
        137.35934450811246
    ],
    [
        30.787500381469727,
        139.48334019353854
    ],
    [
        30.787500381469727,
        141.982158646981
    ],
    [
        30.662500381469727,
        144.48097710042344
    ],
    [
        30.662500381469727,
        147.10473647653802
    ],
    [
        30.662500381469727,
        149.47861400730835
    ],
    [
        30.787500381469727,
        151.9774324607508
    ],
    [
        30.912500381469727,
        154.35130999152113
    ],
    [
        30.912500381469727,
        156.9750693676357
    ],
    [
        30.662500381469727,
        159.47388782107814
    ],
    [
        30.662500381469727,
        162.0976471971927
    ],
    [
        30.662500381469727,
        164.09670195994667
    ],
    [
        30.662500381469727,
        166.59552041338912
    ],
    [
        30.662500381469727,
        168.84445702148733
    ],
    [
        30.537500381469727,
        171.34327547492978
    ],
    [
        30.662500381469727,
        173.0924483923395
    ],
    [
        30.662500381469727,
        175.2164440777656
    ],
    [
        30.662500381469727,
        115.24480119514678
    ],
    [
        30.662500381469727,
        113.37068735506494
    ],
    [
        30.787500381469727,
        111.12175074696674
    ],
    [
        30.662500381469727,
        109.12269598421278
    ],
    [
        32.53750038146973,
        108.37305044818004
    ],
    [
        34.78750038146973,
        108.37305044818004
    ],
    [
        37.16250038146973,
        108.24810952550791
    ],
    [
        39.53750038146973,
        108.49799137085216
    ],
    [
        41.91250038146973,
        108.49799137085216
    ],
    [
        44.66250038146973,
        108.24810952550791
    ],
    [
        46.41250038146973,
        108.12316860283579
    ],
    [
        30.662500381469727,
        106.99870029878669
    ],
    [
        30.787500381469727,
        105.12458645870485
    ],
    [
        31.162500381469727,
        103.37541354129513
    ],
    [
        30.662500381469727,
        101.37635877854117
    ],
    [
        30.912500381469727,
        99.12742217044297
    ],
    [
        33.16250038146973,
        98.00295386639387
    ],
    [
        35.16250038146973,
        97.75307202104963
    ],
    [
        37.16250038146973,
        98.00295386639387
    ],
    [
        39.03750038146973,
        98.12789478906599
    ],
    [
        41.28750038146973,
        98.12789478906599
    ],
    [
        43.28750038146973,
        98.00295386639387
    ],
    [
        45.78750038146973,
        97.75307202104963
    ],
    [
        30.912500381469727,
        97.00342648501689
    ],
    [
        30.537500381469727,
        95.12931264493506
    ],
    [
        30.287500381469727,
        93.1302578821811
    ],
    [
        30.662500381469727,
        91.13120311942713
    ],
    [
        30.162500381469727,
        89.13214835667317
    ],
    [
        32.16250038146973,
        88.25756189796832
    ],
    [
        34.66250038146973,
        88.13262097529619
    ],
    [
        36.91250038146973,
        88.25756189796832
    ],
    [
        39.28750038146973,
        88.25756189796832
    ],
    [
        42.03750038146973,
        88.13262097529619
    ],
    [
        44.53750038146973,
        88.13262097529619
    ],
    [
        31.037500381469727,
        86.50838898055859
    ],
    [
        31.037500381469727,
        84.63427514047676
    ],
    [
        30.787500381469727,
        82.6352203777228
    ],
    [
        30.537500381469727,
        80.51122469229671
    ],
    [
        32.53750038146973,
        79.38675638824762
    ],
    [
        35.03750038146973,
        79.51169731091974
    ],
    [
        37.41250038146973,
        79.51169731091974
    ],
    [
        39.53750038146973,
        79.51169731091974
    ],
    [
        41.66250038146973,
        79.51169731091974
    ],
    [
        43.78750038146973,
        79.51169731091974
    ],
    [
        46.41250038146973,
        79.51169731091974
    ],
    [
        47.66250038146973,
        81.76063391901795
    ],
    [
        48.16250038146973,
        79.76157915626398
    ],
    [
        48.03750038146973,
        77.6375834708379
    ],
    [
        47.41250038146973,
        75.76346963075606
    ],
    [
        48.16250038146973,
        73.76441486800209
    ],
    [
        47.91250038146973,
        71.76536010524813
    ],
    [
        50.16250038146973,
        71.76536010524813
    ],
    [
        52.16250038146973,
        71.76536010524813
    ],
    [
        54.41250038146973,
        71.64041918257601
    ],
    [
        56.66250038146973,
        71.39053733723176
    ],
    [
        59.03750038146973,
        71.76536010524813
    ],
    [
        61.41250038146973,
        71.64041918257601
    ],
    [
        47.91250038146973,
        69.64136441982205
    ],
    [
        48.03750038146973,
        67.89219150241235
    ],
    [
        48.03750038146973,
        65.76819581698626
    ],
    [
        48.16250038146973,
        64.01902289957654
    ],
    [
        47.66250038146973,
        62.14490905949471
    ],
    [
        60.66250038146973,
        61.14538167811772
    ],
    [
        62.66250038146973,
        61.39526352346197
    ],
    [
        58.28750038146973,
        61.27032260078985
    ],
    [
        55.78750038146973,
        61.020440755445605
    ],
    [
        53.53750038146973,
        61.020440755445605
    ],
    [
        51.66250038146973,
        61.020440755445605
    ],
    [
        49.91250038146973,
        61.020440755445605
    ],
    [
        48.16250038146973,
        60.39573614208499
    ],
    [
        47.91250038146973,
        58.14679953398678
    ],
    [
        48.16250038146973,
        55.897862925888575
    ],
    [
        47.53750038146973,
        53.773867240462494
    ],
    [
        47.78750038146973,
        51.486412214588185
    ],
    [
        47.78750038146973,
        49.48735745183422
    ],
    [
        47.66250038146973,
        47.48830268908026
    ],
    [
        47.91250038146973,
        45.364307003654176
    ],
    [
        50.03750038146973,
        45.23936608098205
    ],
    [
        52.66250038146973,
        45.364307003654176
    ],
    [
        54.41250038146973,
        45.364307003654176
    ],
    [
        56.28750038146973,
        45.364307003654176
    ],
    [
        58.41250038146973,
        44.9894842356378
    ],
    [
        62.16250038146973,
        43.8650159315887
    ],
    [
        60.28750038146973,
        45.48924792632629
    ],
    [
        47.66250038146973,
        43.240311318228095
    ],
    [
        47.78750038146973,
        41.12984434088595
    ],
    [
        47.28750038146973,
        38.880907732787755
    ],
    [
        47.78750038146973,
        36.88185297003379
    ],
    [
        49.66250038146973,
        36.756912047361666
    ],
    [
        51.78750038146973,
        36.88185297003379
    ],
    [
        54.28750038146973,
        37.13173481537804
    ],
    [
        56.78750038146973,
        37.13173481537804
    ],
    [
        59.53750038146973,
        36.756912047361666
    ],
    [
        47.53750038146973,
        34.75785728460771
    ],
    [
        47.78750038146973,
        32.88374344452587
    ],
    [
        53.03750038146973,
        32.259038831165256
    ],
    [
        55.78750038146973,
        32.259038831165256
    ],
    [
        58.03750038146973,
        32.38397975383738
    ],
    [
        60.41250038146973,
        32.259038831165256
    ],
    [
        50.28750038146973,
        32.38397975383738
    ],
    [
        47.53750038146973,
        30.384924991083423
    ],
    [
        47.66250038146973,
        28.38587022832946
    ],
    [
        50.03750038146973,
        28.635752073673707
    ],
    [
        52.28750038146973,
        28.635752073673707
    ],
    [
        54.78750038146973,
        28.635752073673707
    ],
    [
        57.28750038146973,
        28.635752073673707
    ],
    [
        59.66250038146973,
        28.635752073673707
    ],
    [
        62.41250038146973,
        26.136933620231254
    ],
    [
        61.78750038146973,
        28.260929305657335
    ],
    [
        47.78750038146973,
        26.386815465575502
    ],
    [
        47.78750038146973,
        24.233812812161574
    ],
    [
        47.66250038146973,
        22.109817126735486
    ],
    [
        52.28750038146973,
        19.735939595965164
    ],
    [
        55.03750038146973,
        19.61099867329304
    ],
    [
        56.78750038146973,
        19.61099867329304
    ],
    [
        58.41250038146973,
        19.61099867329304
    ],
    [
        60.28750038146973,
        19.236175905276667
    ],
    [
        61.91250038146973,
        18.986294059932426
    ],
    [
        62.28750038146973,
        21.23523066803063
    ],
    [
        63.78750038146973,
        19.236175905276667
    ],
    [
        66.03750038146973,
        18.986294059932426
    ],
    [
        68.03750038146973,
        19.236175905276667
    ],
    [
        70.28750038146973,
        19.985821441309405
    ],
    [
        72.16250038146973,
        20.235703286653646
    ],
    [
        74.53750038146973,
        23.8589900441452
    ],
    [
        74.78750038146973,
        21.485112513374872
    ],
    [
        49.78750038146973,
        19.236175905276667
    ],
    [
        47.16250038146973,
        19.236175905276667
    ],
    [
        44.66250038146973,
        19.111234982604543
    ],
    [
        42.41250038146973,
        19.236175905276667
    ],
    [
        39.78750038146973,
        18.861353137260302
    ],
    [
        37.03750038146973,
        19.111234982604543
    ],
    [
        34.53750038146973,
        18.861353137260302
    ],
    [
        32.03750038146973,
        18.861353137260302
    ],
    [
        29.412500381469727,
        18.861353137260302
    ],
    [
        30.537500381469727,
        20.735466977342142
    ],
    [
        30.412500381469727,
        23.23428543078459
    ],
    [
        30.412500381469727,
        25.73310388422704
    ],
    [
        30.537500381469727,
        27.857099569653123
    ],
    [
        32.78750038146973,
        28.356863260341612
    ],
    [
        34.91250038146973,
        28.356863260341612
    ],
    [
        37.03750038146973,
        28.356863260341612
    ],
    [
        39.66250038146973,
        28.731686028357984
    ],
    [
        41.91250038146973,
        28.731686028357984
    ],
    [
        44.66250038146973,
        28.356863260341612
    ],
    [
        30.912500381469727,
        29.60627248706284
    ],
    [
        30.537500381469727,
        32.10509094050529
    ],
    [
        30.662500381469727,
        34.22908662593137
    ],
    [
        30.787500381469727,
        36.727905079373826
    ],
    [
        33.53750038146973,
        37.227668770062316
    ],
    [
        36.41250038146973,
        37.227668770062316
    ],
    [
        38.66250038146973,
        37.227668770062316
    ],
    [
        41.28750038146973,
        37.227668770062316
    ],
    [
        43.41250038146973,
        36.85284600204594
    ],
    [
        45.91250038146973,
        37.227668770062316
    ],
    [
        30.537500381469727,
        38.72695984212778
    ],
    [
        30.412500381469727,
        40.4761327595375
    ],
    [
        30.787500381469727,
        42.225305676947215
    ],
    [
        30.787500381469727,
        44.099419517029055
    ],
    [
        33.41250038146973,
        44.72412413038967
    ],
    [
        35.66250038146973,
        44.72412413038967
    ],
    [
        38.03750038146973,
        44.849065053061786
    ],
    [
        40.41250038146973,
        44.72412413038967
    ],
    [
        42.41250038146973,
        44.72412413038967
    ],
    [
        44.91250038146973,
        44.72412413038967
    ],
    [
        30.787500381469727,
        45.72365151176665
    ],
    [
        30.662500381469727,
        49.97164288261881
    ],
    [
        30.787500381469727,
        51.84575672270065
    ],
    [
        33.28750038146973,
        53.095165949421876
    ],
    [
        35.78750038146973,
        53.46998871743824
    ],
    [
        38.28750038146973,
        53.34504779476612
    ],
    [
        40.53750038146973,
        53.34504779476612
    ],
    [
        42.91250038146973,
        53.46998871743824
    ],
    [
        45.16250038146973,
        53.46998871743824
    ],
    [
        30.912500381469727,
        53.844811485454606
    ],
    [
        30.537500381469727,
        55.84386624820857
    ],
    [
        30.662500381469727,
        57.7179800882904
    ],
    [
        30.787500381469727,
        60.21679854173286
    ],
    [
        30.662500381469727,
        62.215853304486814
    ],
    [
        32.66250038146973,
        63.46526253120804
    ],
    [
        34.53750038146973,
        63.09043976319168
    ],
    [
        36.16250038146973,
        63.21538068586379
    ],
    [
        38.03750038146973,
        63.46526253120804
    ],
    [
        39.78750038146973,
        63.21538068586379
    ],
    [
        41.91250038146973,
        63.21538068586379
    ],
    [
        44.03750038146973,
        63.340321608535916
    ],
    [
        45.66250038146973,
        63.340321608535916
    ],
    [
        30.412500381469727,
        64.3398489899129
    ],
    [
        30.912500381469727,
        66.21396282999474
    ],
    [
        35.28750038146973,
        71.21159973687963
    ],
    [
        37.78750038146973,
        71.21159973687963
    ],
    [
        39.78750038146973,
        71.21159973687963
    ],
    [
        41.53750038146973,
        71.46148158222388
    ],
    [
        43.66250038146973,
        71.586422504896
    ],
    [
        45.91250038146973,
        71.33654065955176
    ],
    [
        32.91250038146973,
        71.21159973687963
    ],
    [
        30.412500381469727,
        72.33606804092874
    ],
    [
        30.537500381469727,
        73.96030003566634
    ],
    [
        30.537500381469727,
        75.70947295307604
    ],
    [
        30.662500381469727,
        77.70852771583002
    ],
    [
        30.912500381469727,
        177.4113840081838
    ],
    [
        48.03750038146973,
        179.6915134454013
    ],
    [
        48.03750038146973,
        177.71526253120803
    ],
    [
        45.53750038146973,
        180.46396282999473
    ],
    [
        43.78750038146973,
        180.08914006197836
    ],
    [
        41.53750038146973,
        179.96419913930623
    ],
    [
        39.66250038146973,
        179.96419913930623
    ],
    [
        37.53750038146973,
        179.46443544861773
    ],
    [
        35.41250038146973,
        179.96419913930623
    ],
    [
        33.03750038146973,
        179.96419913930623
    ],
    [
        30.412500381469727,
        180.08914006197836
    ],
    [
        30.912500381469727,
        68.51689611577294
    ],
    [
        30.662500381469727,
        70.5159508785269
    ],
    [
        28.662500381469727,
        69.64136441982204
    ],
    [
        26.287500381469727,
        70.01618718783841
    ],
    [
        23.662500381469727,
        69.76630534249416
    ],
    [
        21.037500381469727,
        69.76630534249416
    ],
    [
        19.412500381469727,
        69.76630534249416
    ],
    [
        16.787500381469727,
        69.76630534249416
    ],
    [
        14.537500381469727,
        69.76630534249416
    ],
    [
        12.287500381469727,
        69.89124626516629
    ],
    [
        12.037500381469727,
        67.89219150241232
    ],
    [
        11.912500381469727,
        65.76819581698624
    ],
    [
        11.912500381469727,
        63.51925920888804
    ],
    [
        14.537500381469727,
        61.6451453688062
    ],
    [
        16.787500381469727,
        62.01996813682256
    ],
    [
        19.037500381469727,
        61.6451453688062
    ],
    [
        21.037500381469727,
        61.6451453688062
    ],
    [
        23.537500381469727,
        61.77008629147832
    ],
    [
        25.662500381469727,
        61.52020444613407
    ],
    [
        28.162500381469727,
        61.77008629147832
    ],
    [
        11.787500381469727,
        61.6451453688062
    ],
    [
        12.287500381469727,
        59.64609060605223
    ],
    [
        12.037500381469727,
        57.27221307528191
    ],
    [
        15.662500381469727,
        55.64798108054431
    ],
    [
        18.037500381469727,
        55.64798108054431
    ],
    [
        19.662500381469727,
        55.64798108054431
    ],
    [
        21.537500381469727,
        55.523040157872195
    ],
    [
        24.412500381469727,
        55.523040157872195
    ],
    [
        26.662500381469727,
        55.523040157872195
    ],
    [
        28.912500381469727,
        55.523040157872195
    ],
    [
        13.037500381469727,
        55.349183207717545
    ],
    [
        12.412500381469727,
        52.975305676947215
    ],
    [
        12.037500381469727,
        50.601428146176886
    ],
    [
        12.037500381469727,
        48.477432460750805
    ],
    [
        14.037500381469727,
        46.97814138868534
    ],
    [
        16.537500381469727,
        46.85320046601321
    ],
    [
        18.537500381469727,
        46.85320046601321
    ],
    [
        20.537500381469727,
        46.85320046601321
    ],
    [
        22.787500381469727,
        46.97814138868534
    ],
    [
        24.787500381469727,
        46.97814138868534
    ],
    [
        31.037500381469727,
        47.977668770062316
    ],
    [
        28.787500381469727,
        46.97814138868534
    ],
    [
        27.037500381469727,
        46.97814138868534
    ],
    [
        11.787500381469727,
        46.103554929980476
    ],
    [
        12.162500381469727,
        43.60473647653802
    ],
    [
        12.537500381469727,
        41.48074079111194
    ],
    [
        12.412500381469727,
        39.481686028357984
    ],
    [
        12.037500381469727,
        37.607572188276144
    ],
    [
        14.037500381469727,
        37.98239495629251
    ],
    [
        21.037500381469727,
        38.482158646981
    ],
    [
        23.412500381469727,
        38.85698141499737
    ],
    [
        26.037500381469727,
        38.981922337669495
    ],
    [
        28.537500381469727,
        38.85698141499737
    ],
    [
        18.662500381469727,
        39.10686326034161
    ],
    [
        16.037500381469727,
        38.60709956965312
    ],
    [
        16.037500381469727,
        36.48310388422704
    ],
    [
        15.537500381469727,
        33.98428543078459
    ],
    [
        15.912500381469727,
        31.98523066803063
    ],
    [
        16.037500381469727,
        29.986175905276667
    ],
    [
        17.912500381469727,
        28.98664852389969
    ],
    [
        20.537500381469727,
        29.236530369243937
    ],
    [
        22.787500381469727,
        29.236530369243937
    ],
    [
        25.037500381469727,
        29.236530369243937
    ],
    [
        29.287500381469727,
        29.486412214588185
    ],
    [
        27.537500381469727,
        28.98664852389969
    ],
    [
        15.662500381469727,
        27.98712114252271
    ],
    [
        15.912500381469727,
        25.988066379768753
    ],
    [
        15.912500381469727,
        23.739129771670548
    ],
    [
        15.912500381469727,
        21.61513408624446
    ],
    [
        15.912500381469727,
        19.616079323490496
    ],
    [
        17.912500381469727,
        18.99137471012989
    ],
    [
        20.037500381469727,
        19.241256555474138
    ],
    [
        22.287500381469727,
        18.99137471012989
    ],
    [
        24.412500381469727,
        19.366197478146255
    ],
    [
        27.162500381469727,
        18.99137471012989
    ]
];

interface Graph {
    [key: string]: { [key: string]: number };
}

const TrolleyRoute: React.FC<TrolleyRouteProps> = ({
    points,
    setPoints

}) => {
    //   const [points, setPoints] = useState<PointWithMarker[]>([]);
    const [activePoints, setActivePoints] = useState<Point[]>([]);
    const coordInfoRef = useRef<HTMLDivElement>(null);
    let markerCounter = 1;
    useEffect(() => {
        const img = new Image();

        img.src = '/Img/Layoutdenso.png';
    }, []);

    const getDistance = (p1: Point, p2: Point): number => {
        return Math.sqrt(Math.pow(p2[0] - p1[0], 2) + Math.pow(p2[1] - p1[1], 2));
    };

    const buildGraph = (): Graph => {
        const graph: Graph = {};

        allowedCoordinates.forEach((point1, i) => {
            const pointKey1 = `${point1[0]},${point1[1]}`;
            graph[pointKey1] = {};

            allowedCoordinates.forEach((point2, j) => {
                if (i !== j) {
                    const pointKey2 = `${point2[0]},${point2[1]}`;
                    const distance = getDistance(point1, point2);

                    if (distance < 5) {
                        graph[pointKey1][pointKey2] = distance;
                    }
                }
            });
        });

        return graph;
    };

    const findShortestPath = (start: Point, end: Point): Point[] => {
        const graph = buildGraph();
        const startKey = `${start[0]},${start[1]}`;
        const endKey = `${end[0]},${end[1]}`;

        const distances: { [key: string]: number } = {};
        const previous: { [key: string]: string | null } = {};
        const unvisited = new Set<string>();

        Object.keys(graph).forEach(vertex => {
            distances[vertex] = Infinity;
            previous[vertex] = null;
            unvisited.add(vertex);
        });
        distances[startKey] = 0;

        while (unvisited.size > 0) {
            let minDistance = Infinity;
            let current = '';
            unvisited.forEach(vertex => {
                if (distances[vertex] < minDistance) {
                    minDistance = distances[vertex];
                    current = vertex;
                }
            });

            if (current === endKey) break;

            unvisited.delete(current);

            Object.entries(graph[current] || {}).forEach(([neighbor, distance]) => {
                if (unvisited.has(neighbor)) {
                    const alt = distances[current] + distance;
                    if (alt < distances[neighbor]) {
                        distances[neighbor] = alt;
                        previous[neighbor] = current;
                    }
                }
            });
        }

        const path: Point[] = [];
        let current = endKey;
        while (current) {
            const [lat, lng] = current.split(',').map(Number);
            path.unshift([lat, lng]);
            current = previous[current] || '';
        }

        return path;
    };

    const getNearestAllowedPoint = (lat: number, lng: number): Point => {
        return allowedCoordinates.reduce((nearest, point) => {
            const distance = getDistance([lat, lng], point);
            const currentDistance = getDistance([lat, lng], nearest);
            return distance < currentDistance ? point : nearest;
        }, allowedCoordinates[0]);
    };

    const MapClickHandler: React.FC = () => {
        useMapEvents({
            click(e) {
                const { lat, lng } = e.latlng;
                const newPoint = getNearestAllowedPoint(lat, lng);

                setPoints(prev => {
                    if (prev.length === 0) {
                        return [{ coordinates: newPoint, showMarker: true }];
                    }

                    const lastPoint = prev[prev.length - 1].coordinates;
                    const path = findShortestPath(lastPoint, newPoint);
                    const pathWithMarkers = path.slice(1).map((point, index, array) => ({
                        coordinates: point,
                        showMarker: index === array.length - 1
                    }));
                    return [...prev, ...pathWithMarkers];
                });

                if (coordInfoRef.current) {
                    coordInfoRef.current.textContent = `Clicked at: (${lat.toFixed(2)}, ${lng.toFixed(2)})`;
                }
            },
            mousemove(e) {
                const { lat, lng } = e.latlng;
                if (coordInfoRef.current) {
                    coordInfoRef.current.textContent = `Coordinates: (${lat.toFixed(2)}, ${lng.toFixed(2)})`;
                }
            }
        });
        return null;
    };

    //   const trolleyIcon = L.icon({
    //     iconUrl: '/Img/trolleyLive.png',
    //     iconSize: [25, 25],
    //     iconAnchor: [12, 12],
    //   });
    const getNumberedIcon = (number:number) => {
        return L.divIcon({

            html: `<div style="display: flex; align-items: center; justify-content: center;

              width: 25px; height: 25px; background-color: red; border-radius: 50%; color: white;

              font-size: 14px;">${number}</div>`,

            className: '',

            iconSize: [25, 25],

            iconAnchor: [12, 12],

        });

    };
    const handleMarkerClick = (point: Point) => {
        setPoints(prevPoints => prevPoints.filter(p =>
            !(p.coordinates[0] === point[0] && p.coordinates[1] === point[1])
        ));

        setActivePoints(prev => prev.filter(p => p[0] !== point[0] || p[1] !== point[1]));
    };

    const imageBounds: [[number, number], [number, number]] = [
        [0, 0],
        [100, 220],
    ];

      useEffect(() => {
        const activeMarkers = points.filter(point => point.showMarker).map(point => point.coordinates);
        setActivePoints(activeMarkers);
      }, [points]);

  

    return (
        <Grid container spacing={2}>
            <Grid item xs={12}>
                <Paper elevation={3} sx={{ height: '550px', position: 'relative', overflow: 'hidden' }}>
                    <MapContainer
                        center={[50, 100]}
                        zoom={2}
                        minZoom={1}
                        maxZoom={3}
                        style={{ height: '100%', width: '100%' }}
                        crs={L.CRS.Simple}
                        maxBounds={[[-10, -10], [110, 210]]}
                        maxBoundsViscosity={1.0}
                    >
                        <ImageOverlay url="/Img/Layoutdenso.png" bounds={imageBounds} />
                        <MapClickHandler />

                        {points.map((point, index) => (
                            <React.Fragment key={`${point.coordinates[0]}-${point.coordinates[1]}-${index}`}>
                             
                                {point.showMarker && (
                                    <Marker
                                        position={point.coordinates}
                                        icon={ getNumberedIcon(markerCounter++) } 
                                        eventHandlers={{
                                            click: () => handleMarkerClick(point.coordinates),
                                        }}
                                    />
                                )}
                                {index < points.length - 1 && (
                                    <Polyline
                                        positions={[
                                            point.coordinates,
                                            points[index + 1].coordinates
                                        ]}
                                        pathOptions={{ color: 'black' }}
                                    />
                                )}
                            </React.Fragment>
                        ))}
                    </MapContainer>

                    <Paper
                        ref={coordInfoRef}
                        sx={{
                            position: 'absolute',
                            top: 106,
                            left: 16,
                            padding: '4px 8px',
                            backgroundColor: 'rgba(255, 255, 255, 0.8)',
                            zIndex: 1000,
                        }}
                    />

                    <Box sx={{ position: 'absolute', bottom: 16, left: 16, zIndex: 1000 }}>
                        <Button
                            startIcon={<DeleteIcon />}
                            onClick={() => setPoints([])}
                            color="error"
                            disabled={points.length === 0}
                            variant="contained"
                        >
                            Clear Route
                        </Button>
                    </Box>
                </Paper>
            </Grid>
        </Grid>
    );
};

export default TrolleyRoute;